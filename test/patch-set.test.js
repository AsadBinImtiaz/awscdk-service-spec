"use strict";
/**
 * patch set testing
 */
Object.defineProperty(exports, "__esModule", { value: true });
const patch_set_1 = require("../build-tools/patch-set");
function evaluate(p) {
    return patch_set_1.evaluatePatchSet(p, { quiet: true });
}
test('can combine two independent records', () => {
    expect(evaluate({
        '001': {
            type: 'fragment',
            data: { a: 'a' },
        },
        '002': {
            type: 'fragment',
            data: { b: 'b' },
        },
    })).toEqual({
        a: 'a',
        b: 'b',
    });
});
test('can combine two records with same value', () => {
    expect(evaluate({
        '001': {
            type: 'fragment',
            data: { a: 'a', b: 'b' },
        },
        '002': {
            type: 'fragment',
            data: { b: 'b', c: 'c' },
        },
    })).toEqual({
        a: 'a',
        b: 'b',
        c: 'c',
    });
});
test('cannot combine two records with conflicting values', () => {
    expect(() => evaluate({
        '001': {
            type: 'fragment',
            data: { a: 'a' },
        },
        '002': {
            type: 'fragment',
            data: { a: 'x' },
        },
    })).toThrow(/Conflict/);
});
test('can apply json patches to records', () => {
    expect(evaluate({
        '001': {
            type: 'fragment',
            data: { a: 'a' },
        },
        '002': {
            type: 'patch',
            data: {
                patch: {
                    operations: [{
                            op: 'move',
                            from: '/a',
                            path: '/b',
                        }],
                },
            },
        },
    })).toEqual({
        b: 'a',
    });
});
test('can apply json patches in nested context', () => {
    expect(evaluate({
        '001': {
            type: 'fragment',
            data: { nested: { a: 'a' } },
        },
        '002': {
            type: 'patch',
            data: {
                nested: {
                    patch: {
                        operations: [{
                                op: 'move',
                                from: '/a',
                                path: '/b',
                            }],
                    },
                },
            },
        },
    })).toEqual({
        nested: { b: 'a' },
    });
});
test('relative json patch paths can reference from the root', () => {
    expect(evaluate({
        '001': {
            type: 'fragment',
            data: { a: 'a', nested: { b: 'b' } },
        },
        '002': {
            type: 'patch',
            data: {
                nested: {
                    patch: {
                        operations: [{
                                op: 'move',
                                from: '$/a',
                                path: '/a',
                            }],
                    },
                },
            },
        },
    })).toEqual({
        nested: { a: 'a', b: 'b' },
    });
});
test('can nest sub-patch sets', () => {
    expect(evaluate({
        '001': {
            type: 'fragment',
            data: { a: 'a' },
        },
        '002': {
            type: 'set',
            sources: {
                '001': {
                    type: 'fragment',
                    data: { b: 'b' },
                },
                '002': {
                    type: 'fragment',
                    data: { c: 'c' },
                },
            },
        },
    })).toEqual({
        a: 'a',
        b: 'b',
        c: 'c',
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0Y2gtc2V0LnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwYXRjaC1zZXQudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsd0RBQXNFO0FBRXRFLFNBQVMsUUFBUSxDQUFDLENBQVc7SUFDM0IsT0FBTyw0QkFBZ0IsQ0FBQyxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUM5QyxDQUFDO0FBRUQsSUFBSSxDQUFDLHFDQUFxQyxFQUFFLEdBQUcsRUFBRTtJQUMvQyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ2QsS0FBSyxFQUFFO1lBQ0wsSUFBSSxFQUFFLFVBQVU7WUFDaEIsSUFBSSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRTtTQUNqQjtRQUNELEtBQUssRUFBRTtZQUNMLElBQUksRUFBRSxVQUFVO1lBQ2hCLElBQUksRUFBRSxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUU7U0FDakI7S0FDRixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDVixDQUFDLEVBQUUsR0FBRztRQUNOLENBQUMsRUFBRSxHQUFHO0tBQ1AsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMseUNBQXlDLEVBQUUsR0FBRyxFQUFFO0lBQ25ELE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDZCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsVUFBVTtZQUNoQixJQUFJLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUU7U0FDekI7UUFDRCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsVUFBVTtZQUNoQixJQUFJLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUU7U0FDekI7S0FDRixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDVixDQUFDLEVBQUUsR0FBRztRQUNOLENBQUMs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Q25DLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDZCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsVUFBVTtZQUNoQixJQUFJLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFO1NBQ2pCO1FBQ0QsS0FBSyxFQUFFO1lBQ0wsSUFBSSxFQUFFLEtBQUs7WUFDWCxPQUFPLEVBQUU7Z0JBQ1AsS0FBSyxFQUFFO29CQUNMLElBQUksRUFBRSxVQUFVO29CQUNoQixJQUFJLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFO2lCQUNqQjtnQkFDRCxLQUFLLEVBQUU7b0JBQ0wsSUFBSSxFQUFFLFVBQVU7b0JBQ2hCLElBQUksRUFBRSxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUU7aUJBQ2pCO2FBQ0Y7U0FDRjtLQUNGLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUNWLENBQUMsRUFBRSxHQUFHO1FBQ04sQ0FBQyxFQUFFLEdBQUc7UUFDTixDQUFDLEVBQUUsR0FBRztLQUNQLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBwYXRjaCBzZXQgdGVzdGluZ1xuICovXG5cbmltcG9ydCB7IGV2YWx1YXRlUGF0Y2hTZXQsIFBhdGNoU2V0IH0gZnJvbSAnLi4vYnVpbGQtdG9vbHMvcGF0Y2gtc2V0JztcblxuZnVuY3Rpb24gZXZhbHVhdGUocDogUGF0Y2hTZXQpIHtcbiAgcmV0dXJuIGV2YWx1YXRlUGF0Y2hTZXQocCwgeyBxdWlldDogdHJ1ZSB9KTtcbn1cblxudGVzdCgnY2FuIGNvbWJpbmUgdHdvIGluZGVwZW5kZW50IHJlY29yZHMnLCAoKSA9PiB7XG4gIGV4cGVjdChldmFsdWF0ZSh7XG4gICAgJzAwMSc6IHtcbiAgICAgIHR5cGU6ICdmcmFnbWVudCcsXG4gICAgICBkYXRhOiB7IGE6ICdhJyB9LFxuICAgIH0sXG4gICAgJzAwMic6IHtcbiAgICAgIHR5cGU6ICdmcmFnbWVudCcsXG4gICAgICBkYXRhOiB7IGI6ICdiJyB9LFxuICAgIH0sXG4gIH0pKS50b0VxdWFsKHtcbiAgICBhOiAnYScsXG4gICAgYjogJ2InLFxuICB9KTtcbn0pO1xuXG50ZXN0KCdjYW4gY29tYmluZSB0d28gcmVjb3JkcyB3aXRoIHNhbWUgdmFsdWUnLCAoKSA9PiB7XG4gIGV4cGVjdChldmFsdWF0ZSh7XG4gICAgJzAwMSc6IHtcbiAgICAgIHR5cGU6ICdmcmFnbWVudCcsXG4gICAgICBkYXRhOiB7IGE6ICdhJywgYjogJ2InIH0sXG4gICAgfSxcbiAgICAnMDAyJzoge1xuICAgICAgdHlwZTogJ2ZyYWdtZW50JyxcbiAgICAgIGRhdGE6IHsgYjogJ2InLCBjOiAnYycgfSxcbiAgICB9LFxuICB9KSkudG9FcXVhbCh7XG4gICAgYTogJ2EnLFxuICAgIGI6ICdiJyxcbiAgICBjOiAnYycsXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2Nhbm5vdCBjb21iaW5lIHR3byByZWNvcmRzIHdpdGggY29uZmxpY3RpbmcgdmFsdWVzJywgKCkgPT4ge1xuICBleHBlY3QoKCkgPT4gZXZhbHVhdGUoe1xuICAgICcwMDEnOiB7XG4gICAgICB0eXBlOiAnZnJhZ21lbnQnLFxuICAgICAgZGF0YTogeyBhOiAnYScgfSxcbiAgICB9LFxuICAgICcwMDInOiB7XG4gICAgICB0eXBlOiAnZnJhZ21lbnQnLFxuICAgICAgZGF0YTogeyBhOiAneCcgfSxcbiAgICB9LFxuICB9KSkudG9UaHJvdygvQ29uZmxpY3QvKTtcbn0pO1xuXG50ZXN0KCdjYW4gYXBwbHkganNvbiBwYXRjaGVzIHRvIHJlY29yZHMnLCAoKSA9PiB7XG4gIGV4cGVjdChldmFsdWF0ZSh7XG4gICAgJzAwMSc6IHtcbiAgICAgIHR5cGU6ICdmcmFnbWVudCcsXG4gICAgICBkYXRhOiB7IGE6ICdhJyB9LFxuICAgIH0sXG4gICAgJzAwMic6IHtcbiAgICAgIHR5cGU6ICdwYXRjaCcsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHBhdGNoOiB7XG4gICAgICAgICAgb3BlcmF0aW9uczogW3tcbiAgICAgICAgICAgIG9wOiAnbW92ZScsXG4gICAgICAgICAgICBmcm9tOiAnL2EnLFxuICAgICAgICAgICAgcGF0aDogJy9iJyxcbiAgICAgICAgICB9XSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfSkpLnRvRXF1YWwoe1xuICAgIGI6ICdhJyxcbiAgfSk7XG59KTtcblxudGVzdCgnY2FuIGFwcGx5IGpzb24gcGF0Y2hlcyBpbiBuZXN0ZWQgY29udGV4dCcsICgpID0+IHtcbiAgZXhwZWN0KGV2YWx1YXRlKHtcbiAgICAnMDAxJzoge1xuICAgICAgdHlwZTogJ2ZyYWdtZW50JyxcbiAgICAgIGRhdGE6IHsgbmVzdGVkOiB7IGE6ICdhJyB9IH0sXG4gICAgfSxcbiAgICAnMDAyJzoge1xuICAgICAgdHlwZTogJ3BhdGNoJyxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgbmVzdGVkOiB7XG4gICAgICAgICAgcGF0Y2g6IHtcbiAgICAgICAgICAgIG9wZXJhdGlvbnM6IFt7XG4gICAgICAgICAgICAgIG9wOiAnbW92ZScsXG4gICAgICAgICAgICAgIGZyb206ICcvYScsXG4gICAgICAgICAgICAgIHBhdGg6ICcvYicsXG4gICAgICAgICAgICB9XSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9KSkudG9FcXVhbCh7XG4gICAgbmVzdGVkOiB7IGI6ICdhJyB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdyZWxhdGl2ZSBqc29uIHBhdGNoIHBhdGhzIGNhbiByZWZlcmVuY2UgZnJvbSB0aGUgcm9vdCcsICgpID0+IHtcbiAgZXhwZWN0KGV2YWx1YXRlKHtcbiAgICAnMDAxJzoge1xuICAgICAgdHlwZTogJ2ZyYWdtZW50JyxcbiAgICAgIGRhdGE6IHsgYTogJ2EnLCBuZXN0ZWQ6IHsgYjogJ2InIH0gfSxcbiAgICB9LFxuICAgICcwMDInOiB7XG4gICAgICB0eXBlOiAncGF0Y2gnLFxuICAgICAgZGF0YToge1xuICAgICAgICBuZXN0ZWQ6IHtcbiAgICAgICAgICBwYXRjaDoge1xuICAgICAgICAgICAgb3BlcmF0aW9uczogW3tcbiAgICAgICAgICAgICAgb3A6ICdtb3ZlJyxcbiAgICAgICAgICAgICAgZnJvbTogJyQvYScsXG4gICAgICAgICAgICAgIHBhdGg6ICcvYScsXG4gICAgICAgICAgICB9XSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9KSkudG9FcXVhbCh7XG4gICAgbmVzdGVkOiB7IGE6ICdhJywgYjogJ2InIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2NhbiBuZXN0IHN1Yi1wYXRjaCBzZXRzJywgKCkgPT4ge1xuICBleHBlY3QoZXZhbHVhdGUoe1xuICAgICcwMDEnOiB7XG4gICAgICB0eXBlOiAnZnJhZ21lbnQnLFxuICAgICAgZGF0YTogeyBhOiAnYScgfSxcbiAgICB9LFxuICAgICcwMDInOiB7XG4gICAgICB0eXBlOiAnc2V0JyxcbiAgICAgIHNvdXJjZXM6IHtcbiAgICAgICAgJzAwMSc6IHtcbiAgICAgICAgICB0eXBlOiAnZnJhZ21lbnQnLFxuICAgICAgICAgIGRhdGE6IHsgYjogJ2InIH0sXG4gICAgICAgIH0sXG4gICAgICAgICcwMDInOiB7XG4gICAgICAgICAgdHlwZTogJ2ZyYWdtZW50JyxcbiAgICAgICAgICBkYXRhOiB7IGM6ICdjJyB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9KSkudG9FcXVhbCh7XG4gICAgYTogJ2EnLFxuICAgIGI6ICdiJyxcbiAgICBjOiAnYycsXG4gIH0pO1xufSk7Il19